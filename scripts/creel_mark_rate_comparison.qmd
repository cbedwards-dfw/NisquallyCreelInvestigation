---
title: "creel_mark_rate_comparison"
editor: visual
---

# packages

```{r}
library("CreelEstimateR")
library("suncalc")
library("tidyverse")
library("patchwork")
library("gt")
library("here")
library("mgcv")
library("gratia")
library("framrsquared")
library("cli")
library("here")
```

### mark rates using catch estimates

```{r}

# read in creel catch estimates for the 2023 Nisqually

# catch estimates calculated for total encounters of ALL adult Chinook
estimates_total_encounters <- readr::read_csv(here("cleaned_data/creel_estimates", "model_estimates_stratum_s1s2_total_encounters.csv"))

# catch estimates calculated for total encounters of only AD-clipped (marked) adult Chinook
estimates_ad_encounters <- readr::read_csv(here("cleaned_data/creel_estimates", "model_estimates_stratum_ad_encounters.csv"))

# catch estimates calculated for total encounters of only UM (unmarked) released adult Chinook
estimates_UM_released <- readr::read_csv(here("cleaned_data/creel_estimates", "model_estimates_stratum_um_released.csv"))

# bind together and filter to outputs generated with the Bayesian state space model 
combined <- estimates_total_encounters |> rbind(estimates_ad_encounters, estimates_UM_released) |> 
  filter(model_type == "BSS" & estimate_category == "catch") |>  
  select(event_date = min_event_date, section_num, period, day_type, angler_final, est_cg,
         estimate_category, estimate_type, estimate_value) |> 
  dplyr::mutate(
    management_week = framrsquared::management_week(event_date)
  ) |> 
  pivot_wider(names_from = estimate_type, values_from = estimate_value)

# CE - check out the "combined" object, these are daily catch estimates grouped into two catch groups, "total encounters" - daily catch estimates (i.e., expanded for effort) aggregating Chinook catch over UM,AD,UNK mark status for both released and harvested fish, and "ad encounters" - daily catch estimates (i.e., expanded for effort) aggregating catch for only AD-clipped fish, both released and harvested. 

# CE-  can we accurately propagate error when calculating daily mark rates from these two quantities, given the statistics available?

# think about calculating study design strata level mark rates - could show that certain strata align with net data, while other do not! 

total_mark_rates <- combined |> 
  group_by(est_cg) |> 
   summarise(
    total = sum(mean)
  ) |> 
   pivot_wider(names_from = est_cg, values_from =  total) |> 
  rename(total_ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
  mutate(
    mark_rate = total_ad_encounters/total_encounters
  )

stratum_total_mark_rates <- combined |> 
  group_by(section_num, day_type, angler_final, est_cg) |> 
   summarise(
    total = sum(mean)
  ) |> 
   pivot_wider(names_from = est_cg, values_from =  total) |> 
  rename(total_ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
  mutate(
    mark_rate = total_ad_encounters/total_encounters
  )

# looks like bank catch is has a consistently lower mark rate than boat catch

weekly_catch_mark_rate <- combined |> 
  group_by(management_week, section_num, angler_final, est_cg) |> 
   summarise(
    total = sum(mean)
  ) |> 
  pivot_wider(names_from = est_cg, values_from =  total) |> 
  rename(total_ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
  mutate(
    mark_rate = total_ad_encounters/total_encounters
  )

weekly_catch_mark_rate |> 
  filter(section_num == 1) |> 
  ggplot(aes(management_week, mark_rate)) +
  geom_point() +
  facet_wrap(vars(section_num, angler_final))

catch_totals_weekly |> 
  filter(section_num == 2) |> 
  filter(!(section_num == 2 & angler_final == "Bank")) |> 
  ggplot(aes(management_week, mark_rate)) +
  geom_point() +
  facet_wrap(vars(section_num, angler_final))


### look at weekly mark rates calculated using expanded catch estimates

# create plots to examine potential patterns in catch/mark rate by design strata: section_num (area), day_type (weekday/weekend), anger_final (bank vs boat angler)

# aggregating over section_num and angler_final
combined |> select(event_date, management_week, section_num, day_type, angler_final, est_cg, mean) |> 
  filter(section_num == 1) |> 
  group_by(management_week, est_cg) |> 
   summarise(
    total = sum(mean)
  ) |> 
  pivot_wider(names_from = est_cg, values_from =  total) |> 
  rename(total_ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
  mutate(
    mark_rate = total_ad_encounters/total_encounters
  ) |> 
  ggplot(aes(management_week, mark_rate)) +
  geom_point(size = 2) +
  scale_y_continuous(limits = c(0,1))


# plotted by angler type 
combined |> select(event_date, management_week, section_num, day_type, angler_final, est_cg, mean) |> 
  filter(section_num == 1) |> 
  group_by(management_week, section_num, angler_final, est_cg) |> 
   summarise(
    total = sum(mean)
  ) |> 
  pivot_wider(names_from = est_cg, values_from =  total) |> 
  rename(total_ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
  mutate(
    mark_rate = total_ad_encounters/total_encounters
  ) |> 
  ggplot(aes(management_week, mark_rate, fill = angler_final, color = angler_final)) +
  geom_point(size = 2) +
  scale_y_continuous(limits = c(0,1))

# plotting by angler type, there appears to be a systematic offset between bank and boat, similar to the net vs. sport pattern??

# by viewing the data in light of the design strata, are there clues as to where potential bias are introduced in the data, regarding angler type, time period, or spatial area?

```



```{r}
# plot daily catch time series for three catch groups to visualize mark rate dynamics over time
combined |> 
  # filter(est_cg %in% c("Chinook_Adult_UM_Released", "Chinook_Adult_AD_Kept|Released", "Chinook_Adult_AD|UM|UNK_Kept|Released)) |> 
  filter(section_num == 1 & angler_final == "Bank") |> 
ggplot(aes(x = event_date, y = quantile_median_50, fill = est_cg, color = est_cg)) +
    geom_ribbon(aes(ymin = quantile_lower_2_5, ymax = quantile_upper_97_5), alpha = 0.2, color = "transparent") +
    geom_line(lwd = 1) +
    ylab("Median (50%) catch") +
    xlab("Date") +
    # labs(color = "Angler type", fill = "Angler type") +
    scale_x_date() +
    theme_bw() +
    facet_wrap(~section_num + angler_final)

# UM released and AD encounters track closely - is a significant proportion of the UM Chinook catch unmarked hatchery fish? 
# generate catch estimates for pinks and plot them here?
# generate catch estimates for AD Kept Chinook - these would be considered more reliable due to sampling

```


```{r}

# this may be done incorrectly, ignore for now! 

# strata_compare <- combined |> select(event_date, management_week, section_num, day_type, angler_final, est_cg, mean) |>
#   filter(!(section_num == 2 & angler_final == "Bank")) |> 
#   mutate(
#     section_num = as.factor(section_num),
#     day_type = as.factor(day_type),
#     angler_final = as.factor(angler_final)
#   ) |> 
#   pivot_wider(names_from = est_cg, values_from =  mean) |> 
#    rename(ad_encounters = `Chinook_Adult_AD_Kept|Released`, total_encounters = `Chinook_Adult_AD|UM|UNK_Kept|Released`) |> 
#   mutate(
#     mark_rate = ad_encounters/total_encounters
#   )
# 
# strata_compare |> 
#   pivot_longer(cols = c(section_num, day_type, angler_final), names_to = "design_strata", values_to = "strata_levels") |> 
#   ggplot(aes(mark_rate, strata_levels)) +
#   geom_boxplot() +
#   facet_wrap(.~design_strata)


```


```{r}

# test out the use of the newly packaged up fetch_dwg function, creating a vector of the names of the Nisqually fisheries we want to pull into R

# define fisheries we want data for
# fisheries <- c("Nisqually salmon 2021", "Nisqually salmon 2022", "Nisqually salmon 2023")
# 
# # download the data from data.wa.gov
# datapull <- set_names(fisheries) |>
#   map(~fetch_dwg(fishery_name = .x))
# 
# interviews <- datapull$`Nisqually salmon 2023`$interview |>
#   bind_rows(datapull$`Nisqually salmon 2022`$interview, datapull$`Nisqually salmon 2021`$interview)
# 
# # bind date and waterbody data to the creel interview-based catch records
# catch <- datapull$`Nisqually salmon 2023`$catch |>
#   bind_rows(datapull$`Nisqually salmon 2022`$catch, datapull$`Nisqually salmon 2021`$catch) |>
#   left_join(interviews |>
#               select(interview_id, event_date, water_body),
#             by = "interview_id") |>
#   mutate(
#     year = year(event_date),
#     month = month(event_date)
#   )


```
